{
  "hash": "ee5f1344a1b7ab51413db97c0137326e",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Measuring Adiposity\"\nsubtitle: \"BMI vs. DXA\"\ndescription:  |  \n  Compare BMI and DXA-based adiposity measures and use IPD corrections to \n  improve regression inference under predicted outcomes.\nimage: images/adiposity_cover.png\nunit: 0\ncore: true\nformat:\n  html:\n    toc: true\n    number-sections: false\n    code-fold: true\n    code-tools: false\nexecute:\n  warning: false\n  message: false\n---\n\n\n\n\n## Background and Motivation\n\n### How Do We Measure Adiposity?\n\nBody mass index (BMI) is the most commonly used anthropometric proxy for \nadiposity in epidemiologic studies and clinical settings. It is simple to \ncalculate, weight in kilograms divided by height in meters squared, and has \nwell-established cut-points for classifying patients as overweight or obese. \nHowever, BMI does not distinguish between fat mass and lean mass, nor does it \ncapture fat distribution (visceral versus subcutaneous). As a result, BMI can \nboth under- and over-estimate true adiposity in key subgroups. For example \nmuscular individuals (e.g., athletes) may be misclassified as \"obese,\" while \nolder adults with sarcopenia (low muscle mass) may fall below BMI thresholds \ndespite having high percent body fat. \n\n<br>\n\n![*Source: https://www.medrxiv.org/content/10.1101/2025.04.01.25325037v1.full.pdf*](images/bmi_flowchart.png){width=100%}\n\n<br>\n\nWaist circumference (WC) is another simple measure of central adiposity that \nmay better reflect visceral fat, a key driver of metabolic risk. Standard WC \ncut-points (e.g., ≥ 102 cm in men, ≥ 88 cm in women) identify individuals at \nincreased cardiometabolic risk, even when their BMI is in the normal or \noverweight range. Yet WC also does not directly quantify total body fat and \nis influenced by body build, posture, and measurement error.\n\nDual-energy X-ray absorptiometry (DXA) provides a more accurate \"gold-standard\" \nmeasure of body composition by directly quantifying total and regional fat and \nlean mass. DXA-derived percent fat thresholds (e.g., > 30% in men, > 42% in \nwomen) have been validated against metabolic outcomes. Comparing BMI-based \nobesity (BMI ≥ 30 kg/m²) and WC-based obesity (WC ≥ 102 cm men, ≥ 88 cm women) \nwith DXA-defined obesity reveals where and how often these common \nanthropometric proxies misclassify true adiposity.\n\nIt is worth noting that BMI is often defended as a valid measure for \npopulation-level inference, under the assumption that individual-level \nmisclassification errors are harmless when estimating group-level trends. \nThis justification appears frequently in epidemiology, where BMI is treated \nas a convenient stand-in for adiposity in regression models. But this reasoning \nmasks a deeper issue central to the IPD framework: BMI is itself a prediction \nmodel, a crude one, but a model nonetheless. It encodes a deterministic \nfunction (weight divided by height squared) to approximate an unobserved \nlatent quantity (body fat), and like any prediction model, it introduces \nsystematic biases that may not vanish with aggregation. IPD adopts a \nprediction-agnostic perspective: whether the surrogate is a simple index like \nBMI or a high-dimensional neural network, the challenge is the same: how to \ndraw valid statistical inference when the outcome is a model-based proxy. By \ntreating BMI as a prediction rather than a ground truth, we clarify the role \nof uncertainty, calibration, and correction, and demonstrate how IPD methods \ncan help recover valid estimates even when only such surrogates are available.\n\nIn this module, we will use data from the [National Health and Nutrition Examination Survey  (NHANES)](https://www.cdc.gov/nchs/nhanes/index.html) to:\n\n1. **Load** BMI, WC, and DXA-based measures of adiposity and their associated \nfeatures\n2. **Define** obesity by three standards:\n    - BMI (≥ 30 kg/m²)\n    - Waist circumference (men ≥ 102 cm; women ≥ 88 cm)\n    - DXA % body fat (> 30% men; > 42% women)\n3.  **Visualize** misclassification rates overall and by age, sex, and \nrace/ethnicity\n4.  **Calibrate** both BMI and WC-based obesity measures to DXA using the \n`ipd` package\n5.  **Discuss** implications for research and practice\n\nBy the end, we may have a better understanding of the strengths and limitations \nof BMI and WC as proxies for adiposity, know how to assess \ntheir sensitivity and specificity versus DXA, and be equipped to correct for \nmeasurement error using IPD when only BMI/WC are available.\n\n### NHANES\n\nThe National Health and Nutrition Examination Survey \n([NHANES](https://www.cdc.gov/nchs/nhanes/index.html)) is a nationally \nrepresentative program conducted by the U.S. Centers for Disease Control \nand Prevention that combines in-home interviews with standardized physical \nexaminations and laboratory tests to assess the health and nutritional \nstatus of Americans. Initiated in the early 1960s and carried out continuously \nsince 1999 in two-year cycles, NHANES informs public health policy, tracks \ntrends in chronic conditions and risk factors, and support research on diet, \ndisease, and health disparities. NHANES provides:\n\n- **DXA-measured percent body fat** (`DXDTOPF`) for a subset of participants\n- **BMI** (`BMXBMI`), derived from measured height and weight\n- **Waist circumference** (`BMXWAIST`), a potential measure of central fat\n\nAs DXA scans are costly and time-consuming, many studies only record BMI and \nWC. When our scientific question involves true adiposity (e.g., its association \nwith certain risk factors), but we only have BMI and WC in most participants, \nwe can use `ipd` to correct our downstream inference on % body fat to account \nfor the fact that these proxies are being used in place of the true DXA \nmeasurement.\n\n**Note:** DXA scans were collected through the **2017 - 2018** NHANES cycle \nbut were suspended during the COVID-19 pandemic. As a result, subsequent \nwaves, including the **August 2021 - August 2023** data, do **not** include \nDXA measurements. In this tutorial, we will therefore:\n\n1. Use the **2017-2018** wave as our *labeled* data (which includes `DXDTOPF`).  \n2. Use **IPD** to correct our inference when estimating associations between \n% body fat and other covariates in the absence of direct DXA measurements in \nthe *unlabeled* **August 2021 - August 2023** wave. \n\nThis approach lets us leverage historic DXA data to predict adiposity in more \nrecent participants, enabling unbiased inference across pre- and post-pandemic \ncohorts.\n\n## Data Preparation and Exploration\n\nWe will now load a pre-compiled NHANES dataset, explore key variables (BMI, \nwaist circumference, DXA % body fat) by cohort, and define obesity categories \nfor later misclassification analyses and IPD.\n\n### Loading the Pre-Compiled NHANES Data\n\nFor convenience, we prepared and saved a data file, `data/NHANES.rda`, which\ncontains a tibble, **NHANES**, with the following columns:\n\n- `SEQN`      - Respondent ID  \n- `Cohort`    - Factor: \"2017-2018\" or \"2021-2023\"  \n- `Age`       - Factor: \"Under 20\", \"20-39\", \"40-59\", or \"60+\" \n- `Sex`       - Factor: \"Male\" or \"Female\"  \n- `Race`      - Factor: \"Non-Hispanic White\", \"Hispanic\", \"Non-Hispanic Black\", \"Non-Hispanic Asian\", or \"Other Race - Including Multi-Racial\" \n- `Smoking`   - Factor: \"Never Smoker\", \"Former Smoker\", or \"Current Smoker\"\n- `Education` - Factor: \"Less than high school\", \"High school graduate/GED or equivalent\", \"Some college or AA degree\", \"College graduate or above\", or \"Refused/Unknown\" \n- `BMXBMI`    - Body Mass Index (kg/m²)  \n- `BMXWAIST`  - Waist Circumference (cm)  \n- `DXDTOPF`   - DXA Percent Body Fat (only measured in 2017-2018; `NA` in 2021-2023)\n- `WTMEC4YR`  - Four-Year Adjusted Survey Weights\n\n**Note:** The the code used to produce this dataset is available in this \nrepository at `inst/NHANES_DATA.R`.\n\n### Exercise 1: Install and Load the Necessary Packages\n\n::: {.callout-note collapse=\"true\"}\n## Answer\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Install these packages if you have not already:\n# install.packages(c(\"ipd\", \"broom\", \"scales\", \"tidyverse\"))\n\nlibrary(ipd)        # Inference with predicted data\nlibrary(broom)      # Convert model objects (lm, glm, ipd) into tidy data.frames\nlibrary(scales)     # Formatting scales and labels for ggplot2\nlibrary(tidyverse)  # Meta‐package for data manipulation and visualization\n```\n:::\n\n\n\n\n:::\n\n::: {.callout-tip}\n## Notes\n\nLoad packages once here so all remaining exercises run cleanly.\n:::\n\n### Exercise 2: Load the Data\n\nWe first load the prepared dataset and take a look at its features:\n\n::: {.callout-note collapse=\"true\"}\n## Answer\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load the dataset\nload(\"data/NHANES.RData\")\n\n# Inspect its structure\nglimpse(NHANES)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 11,782\nColumns: 11\n$ SEQN      <dbl> 93706, 93707, 93711, 93712, 93714, 93717, 93719, 93725, 9372…\n$ Cohort    <fct> 2017-2018, 2017-2018, 2017-2018, 2017-2018, 2017-2018, 2017-…\n$ Age       <fct> Under 20, Under 20, 40-59, Under 20, 40-59, 20-39, Under 20,…\n$ Sex       <fct> Male, Male, Male, Male, Female, Male, Female, Female, Male, …\n$ Race      <fct> Non-Hispanic Asian, Other Race - Including Multi-Racial, Non…\n$ Smoking   <fct> NA, NA, NA, NA, Former Smoker, NA, NA, NA, NA, NA, NA, NA, N…\n$ Education <fct> Refused/Unknown, Refused/Unknown, College graduate or above,…\n$ BMXBMI    <dbl> 21.5, 18.1, 21.3, 19.7, 39.9, 24.5, 26.0, 16.1, 27.6, 28.6, …\n$ BMXWAIST  <dbl> 79.3, 64.1, 86.6, 72.0, 118.4, 86.2, 86.0, 66.8, 101.5, 96.3…\n$ DXDTOPF   <dbl> 22.7, 19.0, 22.8, 16.7, 42.1, 20.4, 33.4, 26.9, 29.4, 22.8, …\n$ WTMEC4YR  <dbl> 4361.720, 3532.305, 6195.460, 15168.327, 7739.791, 30058.968…\n```\n\n\n:::\n:::\n\n\n\n\n:::\n\n::: {.callout-tip}\n## Notes\n\nVerify the data schema now to avoid debugging later steps.\n:::\n\n### Exercise 3: Overview by Cohort\n\nWe can now get a sense of the different cohorts and our variables of interest:\n\n#### Sample Sizes\n\n::: {.callout-note collapse=\"true\"}\n## Answer\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNHANES |>\n  count(Cohort) |>\n  mutate(pct = n / sum(n) * 100)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     Cohort    n      pct\n1 2017-2018 3617 30.69937\n2 2021-2023 8165 69.30063\n```\n\n\n:::\n:::\n\n\n\n\n#### DXA Missingness\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNHANES |>\n  group_by(Cohort) |>\n  summarize(\n    total       = n(),\n    pct_missing = mean(is.na(DXDTOPF)) * 100)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 3\n  Cohort    total pct_missing\n  <fct>     <int>       <dbl>\n1 2017-2018  3617           0\n2 2021-2023  8165         100\n```\n\n\n:::\n:::\n\n\n\n\n:::\n\n::: {.callout-tip}\n## Notes\n\nExpected:\n\n* 2017-2018: DXA (`DXDTOPF`) present for analytic participants.\n* 2021-2023: `DXDTOPF` entirely missing (post-pandemic no DXA).\n:::\n\n### Discussion Questions\n\n* Why is this a natural labeled/unlabeled split for IPD?\n* What inferential bias would appear if we ignored the structured missingness?\n\n### Exercise 4: Descriptive Statistics\n\n#### BMI, Waist Circumference, and DXA % Fat\n\n::: {.callout-note collapse=\"true\"}\n## Answer\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNHANES |>\n  group_by(Cohort) |>\n  summarize(\n    BMI_mean = mean(BMXBMI),\n    BMI_sd   = sd(BMXBMI),\n    WC_mean  = mean(BMXWAIST),\n    WC_sd    = sd(BMXWAIST),\n    DXA_mean = mean(DXDTOPF),\n    DXA_sd   = sd(DXDTOPF)\n  ) |>\n  pivot_longer(-Cohort)|>\n  separate(name, c(\"Metric\", \"Statistic\")) |>\n  pivot_wider(names_from = Statistic, values_from = value)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 4\n  Cohort    Metric  mean    sd\n  <fct>     <chr>  <dbl> <dbl>\n1 2017-2018 BMI     26.5  7.24\n2 2017-2018 WC      89.3 18.8 \n3 2017-2018 DXA     32.3  8.70\n4 2021-2023 BMI     27.1  7.96\n5 2021-2023 WC      92.1 22.0 \n6 2021-2023 DXA     NA   NA   \n```\n\n\n:::\n:::\n\n\n\n\n#### Distributions of Continuous Measures of Adiposity\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNHANES |>\n  pivot_longer(c(BMXBMI, BMXWAIST, DXDTOPF)) |>\n  ggplot(aes(x = value, fill = Cohort)) +\n    facet_wrap(~ name, scales = \"free\") +\n    geom_histogram(alpha = 0.6, position = \"identity\", bins = 30) +\n    scale_fill_manual(values = c(\"#00C1D5\", \"#AA4AC4\")) +\n    labs(\n      title = \"Measures of Adiposity by Cohort\", \n      x = \"BMI (kg/m2), WC (cm), or % Fat\", \n      y = \"Count\") +\n    theme_minimal()\n```\n\n::: {.cell-output-display}\n![](Unit02_MeasuringAdiposity_files/figure-html/unnamed-chunk-6-1.png){width=100%}\n:::\n:::\n\n\n\n\n#### DXA vs Anthropometry in 2017-2018\n\nOnly the 2017-2018 cohort has `DXDTOPF`, so we examine how BMI and WC relate to true % body fat among the study participants in this wave:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNHANES |>\n  filter(Cohort == \"2017-2018\") |>\n  pivot_longer(c(BMXBMI, BMXWAIST)) |>\n  ggplot(aes(x = value, y = DXDTOPF)) +\n    facet_wrap(~ name, scales = \"free_x\") +\n    geom_point(alpha = 0.4) +\n    geom_smooth(method = \"lm\", color = \"#1B365D\") +\n    labs(\n      title = \"DXA % Body Fat vs BMI and WC (2017-2018)\",\n      x = \"BMI (kg/m2) or WC (cm)\", y = \"DXDTOPF (%)\") +\n    theme_minimal()\n```\n\n::: {.cell-output-display}\n![](Unit02_MeasuringAdiposity_files/figure-html/unnamed-chunk-7-1.png){width=100%}\n:::\n:::\n\n\n\n\nLet's also compare these measures by Sex. We can also add reference lines to \nsee where the measure-specific obesity cut-offs would be:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncutoffs <- tibble(\n  name = c(\"BMXBMI\", \"BMXBMI\", \"BMXWAIST\", \"BMXWAIST\"),\n  Sex  = c(\"Male\", \"Female\", \"Male\", \"Female\"),\n  xint = c(30, 30, 102, 88),\n  yint = c(30, 42,  30, 42)\n)\n\nNHANES |>\n  filter(Cohort == \"2017-2018\") |>\n  pivot_longer(c(BMXBMI, BMXWAIST)) |>\n  ggplot(aes(x = value, y = DXDTOPF, group = Sex, fill = Sex, color = Sex)) +\n    facet_wrap(~ name, scales = \"free_x\") +\n    geom_point(alpha = 0.4) +\n    geom_smooth(method = \"lm\") +\n    geom_vline(data = cutoffs, \n      aes(xintercept = xint, color = Sex), linetype = \"dashed\") +\n    geom_hline(data = cutoffs, \n      aes(yintercept = yint, color = Sex), linetype = \"dashed\") +\n    scale_fill_manual(values = c(\"#00C1D5\", \"#AA4AC4\")) +\n    scale_color_manual(values = c(\"#00C1D5\", \"#AA4AC4\")) +\n    labs(\n      title = \"DXA % Body Fat vs BMI and WC (2017-2018)\",\n      x = \"BMI (kg/m2) or WC (cm)\", y = \"DXDTOPF (%)\") +\n    theme_minimal()\n```\n\n::: {.cell-output-display}\n![](Unit02_MeasuringAdiposity_files/figure-html/unnamed-chunk-8-1.png){width=100%}\n:::\n:::\n\n\n\n\n:::\n\n::: {.callout-tip}\n## Notes\n\n* BMI and WC both show strong positive association with DXA % fat.\n* Slopes differ by sex, suggesting different proxy behavior across groups.\n* Mismatched quadrants indicate real proxy misclassification.\n:::\n\n### Discussion Questions\n\n* Which proxy looks better aligned with DXA in this cohort?\n* How might sex-specific thresholding improve proxy calibration?\n\n### Exercise 5: Defining Obesity Categories\n\nLet us create three binary indicators:\n\n* **`obese_BMI`**: BMI ≥ 30 kg/m²\n* **`obese_WC`**: WC ≥ 102 cm (men) or ≥ 88 cm (women)\n* **`obese_DXA`**: DXA % Fat > 30% (men) or > 42% (women)\n\n::: {.callout-note collapse=\"true\"}\n## Answer\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNHANES <- NHANES |>\n  mutate(\n    obese_BMI = BMXBMI >= 30,\n    obese_WC  = case_when(\n      Sex == \"Male\"   & BMXWAIST >= 102 ~ TRUE,\n      Sex == \"Female\" & BMXWAIST >=  88 ~ TRUE,\n      .default                          = FALSE),\n    obese_DXA = case_when(\n      is.na(DXDTOPF)                 ~ NA,\n      Sex == \"Male\"   & DXDTOPF > 30 ~ TRUE,\n      Sex == \"Female\" & DXDTOPF > 42 ~ TRUE,\n      .default                       = FALSE)\n  )\n```\n:::\n\n\n\n\n:::\n\n::: {.callout-tip}\n## Notes\n\nThese indicators define proxy outcomes (`obese_BMI`, `obese_WC`) and the reference outcome (`obese_DXA`) for downstream analyses.\n:::\n\n### Exercise 6: Misclassification in 2017-2018\n\nCompare BMI-defined vs DXA-defined obesity:\n\n::: {.callout-note collapse=\"true\"}\n## Answer\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Overall\nNHANES |>\n  filter(Cohort == \"2017-2018\") |>\n  count(obese_DXA, obese_BMI) |>\n  mutate(percent = sprintf(\"%.1f%%\", 100 * n / sum(n)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  obese_DXA obese_BMI    n percent\n1     FALSE     FALSE 2180   60.3%\n2     FALSE      TRUE  307    8.5%\n3      TRUE     FALSE  415   11.5%\n4      TRUE      TRUE  715   19.8%\n```\n\n\n:::\n\n```{.r .cell-code}\n# By Sex\nNHANES |>\n  filter(Cohort == \"2017-2018\") |>\n  count(Sex, obese_DXA, obese_BMI) |>\n  group_by(Sex) |>\n  mutate(percent = sprintf(\"%.1f%%\", 100 * n / sum(n))) |>\n  ungroup()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 8 × 5\n  Sex    obese_DXA obese_BMI     n percent\n  <fct>  <lgl>     <lgl>     <int> <chr>  \n1 Male   FALSE     FALSE      1003 56.1%  \n2 Male   FALSE     TRUE        138 7.7%   \n3 Male   TRUE      FALSE       302 16.9%  \n4 Male   TRUE      TRUE        345 19.3%  \n5 Female FALSE     FALSE      1177 64.4%  \n6 Female FALSE     TRUE        169 9.2%   \n7 Female TRUE      FALSE       113 6.2%   \n8 Female TRUE      TRUE        370 20.2%  \n```\n\n\n:::\n:::\n\n\n\n\nAnd WC-defined vs DXA-defined:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Overall\nNHANES |>\n  filter(Cohort == \"2017-2018\") |>\n  count(obese_DXA, obese_WC) |>\n  mutate(percent = sprintf(\"%.1f%%\", 100 * n / sum(n)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  obese_DXA obese_WC    n percent\n1     FALSE    FALSE 1959   54.2%\n2     FALSE     TRUE  528   14.6%\n3      TRUE    FALSE  319    8.8%\n4      TRUE     TRUE  811   22.4%\n```\n\n\n:::\n\n```{.r .cell-code}\n# By Sex\nNHANES |>\n  filter(Cohort == \"2017-2018\") |>\n  count(Sex, obese_DXA, obese_WC) |>\n  group_by(Sex) |>\n  mutate(percent = sprintf(\"%.1f%%\", 100 * n / sum(n))) |>\n  ungroup()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 8 × 5\n  Sex    obese_DXA obese_WC     n percent\n  <fct>  <lgl>     <lgl>    <int> <chr>  \n1 Male   FALSE     FALSE     1020 57.0%  \n2 Male   FALSE     TRUE       121 6.8%   \n3 Male   TRUE      FALSE      286 16.0%  \n4 Male   TRUE      TRUE       361 20.2%  \n5 Female FALSE     FALSE      939 51.3%  \n6 Female FALSE     TRUE       407 22.3%  \n7 Female TRUE      FALSE       33 1.8%   \n8 Female TRUE      TRUE       450 24.6%  \n```\n\n\n:::\n:::\n\n\n\n\n:::\n\n::: {.callout-tip}\n## Notes\n\n* **BMI vs DXA:** meaningful misclassification, with sex-specific asymmetry.\n* **WC vs DXA:** also misclassifies, with a different error profile from BMI.\n* Proxy choice changes both bias direction and uncertainty in downstream models.\n:::\n\n### Discussion Questions\n\n* Which error pattern would most distort regression coefficients?\n* How might subgroup-specific calibration reduce these errors?\n\n### Exercise 7: Additional Stratified Comparisons by Measure\n\nLet us reshape the data to long format so that BMI, WC, and DXA-defined obesity \nare all in one \"Measure\" column:\n\n::: {.callout-note collapse=\"true\"}\n## Answer\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Assume NHANES is already loaded and has Cohort, Age, Sex, Race, \n# and the three obesity variables\nnhanes_long <- NHANES |>\n  select(Cohort, Age, Sex, Race, obese_BMI, obese_WC, obese_DXA) |>\n  pivot_longer(\n    cols = starts_with(\"obese_\"),\n    names_to = \"Measure\",\n    values_to = \"Obese\"\n  ) |>\n  mutate(\n    Measure = recode(Measure,\n      obese_BMI = \"BMI\",\n      obese_WC  = \"Waist Circumference\",\n      obese_DXA = \"DXA\"\n    )\n  ) |>\n  filter(!is.na(Obese))\n```\n:::\n\n\n\n\n#### By Age Group\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprop_age <- nhanes_long |>\n  group_by(Cohort, Age, Measure, Obese) |>\n  summarize(n = n(), .groups = \"drop\") |>\n  group_by(Cohort, Age, Measure) |>\n  mutate(prop = n / sum(n))\n\nggplot(prop_age, aes(x = Age, y = prop, fill = Obese)) +\n  geom_col(position = \"stack\") +\n  facet_grid(Cohort ~ Measure) +\n  scale_y_continuous(labels = percent_format(accuracy = 1)) +\n  scale_fill_manual(values = c(\"#00C1D5\", \"#AA4AC4\")) +\n  scale_color_manual(values = c(\"#00C1D5\", \"#AA4AC4\")) +\n  labs(\n    x     = \"Age Group\",\n    y     = \"Percent\",\n    fill  = \"Obesity Status\",\n    title = \"Obesity Classification by Age, Cohort, and Measure\"\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](Unit02_MeasuringAdiposity_files/figure-html/unnamed-chunk-13-1.png){width=100%}\n:::\n:::\n\n\n\n\n#### By Sex\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprop_sex <- nhanes_long |>\n  group_by(Cohort, Sex, Measure, Obese) |>\n  summarize(n = n(), .groups = \"drop\") |>\n  group_by(Cohort, Sex, Measure) |>\n  mutate(prop = n / sum(n))\n\nggplot(prop_sex, aes(x = Sex, y = prop, fill = Obese)) +\n  geom_col(position = \"stack\") +\n  facet_grid(Cohort ~ Measure) +\n  scale_y_continuous(labels = percent_format(accuracy = 1)) +\n  scale_fill_manual(values = c(\"#00C1D5\", \"#AA4AC4\")) +\n  scale_color_manual(values = c(\"#00C1D5\", \"#AA4AC4\")) +\n  labs(\n    x     = \"Sex\",\n    y     = \"Percent\",\n    fill  = \"Obesity Status\",\n    title = \"Obesity Classification by Sex, Cohort, and Measure\"\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](Unit02_MeasuringAdiposity_files/figure-html/unnamed-chunk-14-1.png){width=100%}\n:::\n:::\n\n\n\n\n#### By Race/Ethnicity\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprop_race <- nhanes_long |>\n  group_by(Cohort, Race, Measure, Obese) |>\n  summarize(n = n(), .groups = \"drop\") |>\n  group_by(Cohort, Race, Measure) |>\n  mutate(prop = n / sum(n))\n\nggplot(prop_race, aes(x = Race, y = prop, fill = Obese)) +\n  geom_col(position = \"stack\") +\n  facet_grid(Cohort ~ Measure) +\n  scale_y_continuous(labels = percent_format(accuracy = 1)) +\n  scale_fill_manual(values = c(\"#00C1D5\", \"#AA4AC4\")) +\n  scale_color_manual(values = c(\"#00C1D5\", \"#AA4AC4\")) +\n  labs(\n    x     = \"Race / Ethnicity\",\n    y     = \"Percent\",\n    fill  = \"Obesity Status\",\n    title = \"Obesity Classification by Race/Ethnicity, Cohort, and Measure\"\n  ) +\n  theme_minimal() +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1))\n```\n\n::: {.cell-output-display}\n![](Unit02_MeasuringAdiposity_files/figure-html/unnamed-chunk-15-1.png){width=100%}\n:::\n:::\n\n\n\n\n:::\n\n::: {.callout-tip}\n## Notes\n\nStratified charts reveal where proxy-defined obesity diverges most from DXA by subgroup.\n:::\n\n### Discussion Questions\n\nBMI misclassification varies systematically across subgroups:\n\n-   **Age**: Young adults (18-34) often have lower lean mass, so normal-BMI individuals can still have high body fat (\"normal-weight obesity\").\n-   **Sex**: Women generally have higher percent-fat at the same BMI; sex-specific DXA thresholds help adjust for this.\n-   **Race/Ethnicity**: Differences in body composition and fat distribution mean that a single BMI cut-point may not correspond to the same adiposity level across groups.\n\n**Implications**: Reliance on BMI alone can bias epidemiologic associations with true adiposity-driven outcomes (e.g., diabetes, cardiovascular disease). When DXA or other body-composition measures are impractical, consider calibration equations or subgroup-specific BMI thresholds.\n\n**Next:** we will split the combined NHANES data into **labeled** (2017-2018 with `DXDTOPF`) and **unlabeled** (2021-2023 without DXA), and then proceed with IPD using BMI or WC as our proxy.\n\n## Demographic Associations: Naive vs Classical vs IPD\n\n### Exercise 8: Naive vs Classical vs IPD Inference\n\nWe are interested in studying the *association* between *true percent body fat* \n(DXA % fat) and risk factors such as age, sex, and race. We model the *binary*\nobesity outcome (DXA-defined \"true\" vs BMI/WC \"proxy\") as a function of *Age*, \n*Sex*, and *Race* using logistic regression:\n\n- **Naive:** proxy-only model on *unlabeled* data (2021-2023)  \n- **Classical:** true-only model on *labeled* data (2017-2018)  \n- **IPD:** combine both while correcting for proxy error\n\n#### Exercise 8a: Setup Labeled vs Unlabeled Data\n\n::: {.callout-note collapse=\"true\"}\n## Answer\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Split NHANES into labeled (DXA available) vs unlabeled\nlabeled   <- NHANES |> filter(Cohort == \"2017-2018\")\nunlabeled <- NHANES |> filter(Cohort == \"2021-2023\")\n\n# Stack for IPD\ncombined <- bind_rows(\n  labeled   |> mutate(set_label = \"labeled\"),\n  unlabeled |> mutate(set_label = \"unlabeled\")\n)\n```\n:::\n\n\n\n\n:::\n\n::: {.callout-tip}\n## Notes\n\nThis split defines the labeled and unlabeled sets used by IPD.\n:::\n\n#### Exercise 8b: Naive versus Classical Regressions\n\nWe fit:\n\n* **Naive-BMI:**   `lm(BMI ~ Age + Sex + Race,   data = unlabeled)`\n* **Naive-WC:**    `lm(WC  ~ Age + Sex + Race,   data = unlabeled)`\n* **Classical:**   `lm(DXDTOPF ~ Age + Sex + Race, data = labeled)`\n\nFor the naive method, we treat BMI- and WC-based obesity (our 'predictions) as \nthe true outcomes, fit on the **unlabeled** participants:\n\n::: {.callout-note collapse=\"true\"}\n## Answer\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Naive on unlabeled using BMI\nnaive_bmi_fit <- glm(obese_BMI ~ Age + Sex + Race, \n  family = binomial, data = unlabeled)\nnaive_bmi_df  <- broom::tidy(naive_bmi_fit) |>\n  mutate(method = \"Naive (BMI)\")\n\n# Naive on unlabeled using WC\nnaive_wc_fit <- glm(obese_WC ~ Age + Sex + Race,\n  family = binomial, data = unlabeled)\nnaive_wc_df  <- broom::tidy(naive_wc_fit) |>\n  mutate(method = \"Naive (WC)\")\n```\n:::\n\n\n\n\n> **Interpretation:**\n>\n> -   Because we 'predicted' obesity using BMI or WC, the \"naive\" coefficient are biased and the confidence intervals are artifically too narrow.\n\nFor the classical approach, we fit the true model on the **labeled** subset (with actual DXA % fat). That is:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Classical on labeled using DXA\nclass_fit <- glm(obese_DXA ~ Age + Sex + Race,\n  family = binomial, data = labeled)\nclass_df  <- broom::tidy(class_fit) |>\n  mutate(method = \"Classical (DXA)\")\n\n# Combine\ncoef_df <- bind_rows(naive_bmi_df, naive_wc_df, class_df) |>\n  filter(term != \"(Intercept)\") |>\n  mutate(\n    term = recode(term,\n      \"Age20-39\" = \"Age 20-39 (vs Under 20)\",\n      \"Age40-59\" = \"Age 40-59 (vs Under 20)\",\n      \"Age60+\"   = \"Age 60+ (vs Under 20)\",\n      \"SexFemale\" = \"Female (vs Male)\",\n      \"RaceNon-Hispanic Black\" = \"Non-Hispanic Black (vs Non-Hispanic White)\",\n      \"RaceNon-Hispanic Asian\" = \"Non-Hispanic Asian (vs Non-Hispanic White)\",\n      \"RaceHispanic\" = \"Hispanic (vs Non-Hispanic White)\",\n      \"RaceOther Race - Including Multi-Racial\" = \"Other Race - Including Multi-Racial (vs Non-Hispanic White)\"\n    ),\n    method = factor(method, levels = c(\"Classical (DXA)\", \"Naive (BMI)\", \"Naive (WC)\"))\n  )\n    \n# Forest plot\nggplot(coef_df, aes(x = estimate, y = term, color = method)) +\n  geom_point(position = position_dodge(width = 0.6)) +\n  geom_errorbarh(aes(xmin = estimate - 1.96 * std.error,\n                     xmax = estimate + 1.96 * std.error),\n                 height = 0.2,\n                 position = position_dodge(width = 0.6)) +\n  geom_vline(xintercept = 0, linetype = \"dashed\") +\n  scale_y_discrete(limits = rev) +\n  scale_fill_manual(values  = c(\"#1B365D\", \"#00C1D5\", \"#AA4AC4\")) +\n  scale_color_manual(values = c(\"#1B365D\", \"#00C1D5\", \"#AA4AC4\")) +\n  labs(\n    x = \"Log-Odds Estimate (95% CI)\",\n    y = \"Covariate\",\n    title = \"Comparison of Obesity Model Coefficients\",\n    color = \"Model Type\"\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](Unit02_MeasuringAdiposity_files/figure-html/unnamed-chunk-18-1.png){width=100%}\n:::\n:::\n\n\n\n\n:::\n\n::: {.callout-tip}\n## Notes\n\n* Naive models can appear precise but are biased by proxy error.\n* Classical DXA-only estimates are valid but use fewer observations.\n* Compare sign/magnitude shifts across covariates to diagnose proxy bias.\n:::\n\n### Discussion Questions\n\n* Which coefficients are most sensitive to proxy choice?\n* Do BMI and WC induce similar bias patterns?\n\n#### Exercise 9: IPD Corrections\n\nWe now apply **IPD** to leverage all participants (labeled + unlabeled) while adjusting for prediction error. We run two IPD analyses, one using `BMI` as our '`f`' and one using `WC`.\n\n> **A note on two calling styles:**\n>\n> We can either provide a single, *combined* dataset to the `data` argument and the name of the column that gives the set labels in `label`:\n>\n> ipd_bmi_1 <- ipd(\n>   formula = obese_DXA - obese_BMI ~ Age + Sex + Race,\n>   data    = combined,\n>   label   = \"set_label\",\n>   model   = \"logistic\",\n>   method  = \"pspa\"\n> )\n>\n> **or** we can provide the *labeled* set to `data` and the *unlabeled* set to `unlabeled_data` separately:\n>\n> ipd_bmi_2 <- ipd(\n>   formula        = obese_DXA - obese_BMI ~ Age + Sex + Race,\n>   data           = labeled,\n>   unlabeled_data = unlabeled,\n>   model          = \"logistic\",\n>   method         = \"pspa\"\n> )\n\nNow we can try to run the IPD model:\n\n::: {.callout-note collapse=\"true\"}\n## Answer\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Note: This code chunk results in an error, but we have an informative warning\n# We can try running it and see!\n\n# ipd_bmi_fit <- ipd(\n#     formula = obese_DXA - obese_BMI ~ Age + Sex + Race,\n#     method  = \"pspa\",\n#     model   = \"logistic\",\n#     data    = combined,\n#     label   = \"set_label\"\n# )\n# \n# ipd_wc_fit <- ipd(\n#     formula = obese_DXA - obese_WC ~ Age + Sex + Race,\n#     method  = \"pspa\",\n#     model   = \"logistic\",\n#     data    = labeled,\n#     unlabeled_data = unlabeled\n# )\n```\n:::\n\n\n\n\n:::\n\n::: {.callout-tip}\n## Notes\n\nThe warning is expected: labeled and unlabeled datasets must share factor levels for IPD model fitting.\n:::\n\n### Discussion Questions\n\n* Why do mismatched factor levels break IPD fitting?\n* What preprocessing checks should you run before modeling?\n\nWe can see that the *labeled* subset does *not* include any `\"60+\"` observations, but IPD expects the same factor levels in both sets in order to fit the model using all the data. To fix this, let us refactor both the *labeled* and *unlabeled* data so they have consistent age categories:\n\n::: {.callout-note collapse=\"true\"}\n## Answer\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Recode age\nNHANES2 <- NHANES |>\n  mutate(Age_recode = fct_collapse(Age, `40+` = c(\"40-59\", \"60+\")))\n      \n# Split NHANES into labeled (DXA available) vs unlabeled\nlabeled2   <- NHANES2 |> \n  filter(Cohort == \"2017-2018\") |> \n  select(obese_DXA, obese_BMI, obese_WC, Age_recode, Sex, Race)\nunlabeled2 <- NHANES2 |> filter(Cohort == \"2021-2023\") |> \n  select(obese_DXA, obese_BMI, obese_WC, Age_recode, Sex, Race)\n\n# Stack for IPD\ncombined2 <- bind_rows(\n  labeled2   |> mutate(set_label = \"labeled\"),\n  unlabeled2 |> mutate(set_label = \"unlabeled\")\n)\n```\n:::\n\n\n\n\n:::\n\n### Exercise 10: Run IPD and Compare Against Naive/Classical\n\nNow let us rerun `ipd::ipd()` and compare our results to the **Naive** and \n**Classical** models:\n\n::: {.callout-note collapse=\"true\"}\n## Answer\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Note: This code chunk now runs without error!\nipd_bmi_fit <- ipd(\n    formula = obese_DXA - obese_BMI ~ Age_recode + Sex + Race,\n    method  = \"pspa\",\n    model   = \"logistic\",\n    data    = combined2,\n    label   = \"set_label\"\n)\n\nipd_wc_fit <- ipd(\n    formula = obese_DXA - obese_WC ~ Age_recode + Sex + Race,\n    method  = \"pspa\",\n    model   = \"logistic\",\n    data    = labeled2,\n    unlabeled_data = unlabeled2\n)\n\n# Collect results using the tidy() method\nipd_bmi_df <- tidy(ipd_bmi_fit) |>\n  mutate(method = \"IPD (BMI)\")\n\nipd_wc_df  <- tidy(ipd_wc_fit) |>\n  mutate(method = \"IPD (WC)\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Rerun previous models\n# Naive on unlabeled using BMI\nnaive_bmi_fit <- glm(obese_BMI ~ Age_recode + Sex + Race, \n  family = binomial, data = unlabeled2)\nnaive_bmi_df  <- broom::tidy(naive_bmi_fit) |>\n  mutate(method = \"Naive (BMI)\")\n\n# Naive on unlabeled using WC\nnaive_wc_fit <- glm(obese_WC ~ Age_recode + Sex + Race,\n  family = binomial, data = unlabeled2)\nnaive_wc_df  <- broom::tidy(naive_wc_fit) |>\n  mutate(method = \"Naive (WC)\")\n\n# Classical on labeled using DXA\nclass_fit <- glm(obese_DXA ~ Age_recode + Sex + Race,\n  family = binomial, data = labeled2)\nclass_df  <- broom::tidy(class_fit) |>\n  mutate(method = \"Classical (DXA)\")\n\n# Combine\ncoef_df <- bind_rows(\n  ipd_bmi_df, ipd_wc_df, naive_bmi_df, naive_wc_df, class_df) |>\n  filter(term != \"(Intercept)\") |>\n  mutate(\n    term = recode(term,\n      \"Age_recode20-39\" = \"Age 20-39 (vs Under 20)\",\n      \"Age_recode40+\" = \"Age 40+ (vs Under 20)\",\n      \"SexFemale\" = \"Female (vs Male)\",\n      \"RaceNon-Hispanic Black\" = \"Non-Hispanic Black (vs Non-Hispanic White)\",\n      \"RaceNon-Hispanic Asian\" = \"Non-Hispanic Asian (vs Non-Hispanic White)\",\n      \"RaceHispanic\" = \"Hispanic (vs Non-Hispanic White)\",\n      \"RaceOther Race - Including Multi-Racial\" = \"Other Race - Including Multi-Racial (vs Non-Hispanic White)\"\n    ),\n    method = factor(method, \n      levels = c(\"IPD (BMI)\", \"IPD (WC)\", \n                 \"Classical (DXA)\", \"Naive (BMI)\", \"Naive (WC)\"))\n  )\n    \n# Forest plot\nggplot(coef_df, aes(x = estimate, y = term, \n    color = method, fill = method, shape = method)) +\n  geom_point(position = position_dodge(width = 0.6)) +\n  geom_errorbarh(aes(xmin = estimate - 1.96 * std.error,\n                     xmax = estimate + 1.96 * std.error),\n                 height = 0.2,\n                 position = position_dodge(width = 0.6)) +\n  geom_vline(xintercept = 0, linetype = \"dashed\") +\n  scale_y_discrete(limits = rev) +\n  scale_fill_manual(\n    values = c(\n      \"Classical (DXA)\" = \"#1B365D\", \n      \"Naive (BMI)\"     = \"#00C1D5\", \n      \"Naive (WC)\"      = \"#AA4AC4\",\n      \"IPD (BMI)\"       = \"#00C1D5\",\n      \"IPD (WC)\"        = \"#AA4AC4\"\n    )\n  ) +\n  scale_color_manual(\n    values = c(\n      \"Classical (DXA)\" = \"#1B365D\", \n      \"Naive (BMI)\"     = \"#00C1D5\", \n      \"Naive (WC)\"      = \"#AA4AC4\",\n      \"IPD (BMI)\"       = \"#00C1D5\",\n      \"IPD (WC)\"        = \"#AA4AC4\"\n    )\n  ) +\n  scale_shape_manual(\n    values = c(\n      \"Classical (DXA)\" = 16, \n      \"Naive (BMI)\"     = 16, \n      \"Naive (WC)\"      = 16,\n      \"IPD (BMI)\"       = 17,\n      \"IPD (WC)\"        = 17\n    )\n  ) +\n  labs(\n    x = \"Log-Odds Estimate (95% CI)\",\n    y = \"Covariate\",\n    title = \"Comparison of Obesity Model Coefficients\",\n    color = \"Model Type\", fill = \"Model Type\", shape = \"Model Type\"\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](Unit02_MeasuringAdiposity_files/figure-html/unnamed-chunk-20-1.png){width=100%}\n:::\n:::\n\n\n\n\n:::\n\n::: {.callout-tip}\n## Notes\n\nIPD combines both cohorts to correct proxy-induced bias while leveraging unlabeled sample size for efficiency.\n:::\n\n### Discussion Questions\n\n* Which covariates move closest to classical after IPD correction?\n* Do IPD(BMI) and IPD(WC) differ meaningfully in uncertainty?\n\n## Summary and Key Takeaways\n\n- **BMI** and **WC** are imperfect proxies for DXA-based % body fat. \n- **Naive** regression on BMI or WC leads to biased estimates for associations between obesity and risk factors such as age, sex, and race.\n- **Classical** regression on true DXA-based % fat is unbiased but costly.\n- **IPD** allows you to leverage a *large cohort with only BMI + covariates*, correct for prediction error, and recover unbiased estimates with more precision than the **Classical** approach.\n- Understanding how different *proxies* like BMI and WC affect **population-level inference** is important for epidemiologic and clinical studies.\n\n## References\n\n* Visokay, Adam, et al. \"How to measure obesity in public health research? Problems with using BMI for population inference.\" *medRxiv* (2025): 2025-04.\n\n---\n\n*This is the end of the module. We hope this was informative! For question/concerns/suggestions, please reach out to ssalerno@fredhutch.org*\n",
    "supporting": [
      "Unit02_MeasuringAdiposity_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}